!function(e){var r=e.module("ngQueryBuilder",[]);r.directive("queryBuilder",["$compile","templatesFactory",function(r,a){return{restrict:"EA",scope:{data:"=",columns:"=",operations:"="},link:function(n,t,o){var s=n.data||{},p=a.get,c=a.build,i=s.expression?s.expression.match(/[^A-Za-z()]/g):0,l={type:"custom",colName:"",operation:"",value:"",custom:""},d={type:"basic",colName:"",operation:"",value:"",custom:""};n.query=s,n.currIndex=s.expression?i[i.length-1]:0,s.expression=s.expression?s.expression:null,s.operands=s.operands||[e.copy(d)],s.bracketIds=s.bracketIds||[],n.togglePopover=function(r){var a=e.element(r.target).closest(".popover-parent").hasClass("active");e.element(".popover-parent").removeClass("active"),a||e.element(r.target).closest(".popover-parent").addClass("active")},n.newEntry=function(a){n.currIndex=parseInt(n.currIndex),n.currIndex+=1,currIndex=n.currIndex,n.query.operands.push(e.copy(d));var o=p(currIndex);t.find(".query-builder-wrapper").append(r(o.operator)(n)),t.find(".query-builder-wrapper").append(r(o.operandSelection)(n)),n.query.expression=v()},n.changeQueryType=function(r,a){"basic"==a?n.query.operands[r]=e.copy(d):n.query.operands[r]=e.copy(l)},n.changeOperator=function(r,a){var t=e.element(a.target).closest(".operator-wrapper");t.find(".operator").text(r),t.removeClass("active"),n.query.expression=v(),console.log(n.query)},n.addBrackets=function(r){var a=e.element(r.target).closest(".operator-wrapper"),t=a.attr("data-operator-id"),o=a.next(),s=a.prev(),p='<span class="bracket opening-bracket" data-bracket-id="'+t+'">(</span>',c='<span class="bracket closing-bracket" data-bracket-id="'+t+'">)</span>';if(o.hasClass("bracket opening-bracket"))for(o=o.next(),openingBracketsCount=1;o.length>0;){if(o.hasClass("bracket opening-bracket"))openingBracketsCount+=1;else if(o.hasClass("bracket closing-bracket")&&(openingBracketsCount-=1,0==openingBracketsCount)){e.element(o).after(c);break}o=o.next()}else o.after(c);if(s.hasClass("bracket closing-bracket"))for(s=s.prev(),closingBracketsCount=1;s.length>0;){if(s.hasClass("bracket closing-bracket"))closingBracketsCount+=1;else if(s.hasClass("bracket opening-bracket")&&(closingBracketsCount-=1,0==closingBracketsCount)){e.element(s).before(p);break}s=s.prev()}else s.before(p);a.removeClass("active"),u(),n.query.expression=v()},n.removeBrackets=function(r){var a=e.element(r.target).closest(".operator-wrapper"),t=a.attr("data-operator-id"),o=a.closest(".query-builder-wrapper");o.find('.bracket[data-bracket-id="'+t+'"]').remove(),a.removeClass("active"),u(),n.query.expression=v()};var u=function(){for(var r=t.find(".query-builder-wrapper").find(".bracket"),a=[],o=0;o<r.length;o++)bracketId=e.element(r[o]).attr("data-bracket-id"),a.push(parseInt(bracketId));n.query.bracketIds=a},v=function(){for(var r=[],a=e.element(".query-builder-wrapper").children(),n=0;n<a.length;n++){var t=e.element(a[n]),o=t.text();t.hasClass("bracket")?r.push(o):t.hasClass("operator-wrapper")?(o=t.find(".operator").text(),r.push(o)):(o=t.attr("data-opererand-id"),r.push(parseInt(o)))}return r.join("")};t.append('<div class="query-builder-wrapper"></div>'),t.append('<div class="add-sub-query"></div>'),t.find(".add-sub-query").append(r(p(0).addMoreBtn)(n)),n.query.expression?c(t,n.query.expression,n.query.operands,n.query.bracketIds,n):t.find(".query-builder-wrapper").append(r(p(0).operandSelection)(n)),e.element(".query-builder-wrapper").on("click",".popover-parent",function(e){e.stopPropagation()}),e.element("body").on("click",function(){e.element(".query-builder-wrapper .popover-parent").removeClass("active")})}}}]),r.factory("templatesFactory",["$compile",function(e){var r=function(e){e=parseInt(e);var r={};return r.addMoreBtn='<span class="new-entry-btn" ng-click="newEntry($event)" data-curr-index="{{currIndex}}"><span class="plus-icon">+</span></span>',r.operator='<div class="operator-wrapper popover-parent" data-operator-id="'+e+'"><span class="operator query-builder-label neutral" ng-click="togglePopover($event)">AND</span><div class="operator-popover query-popover"><div class="popover-body"><span class="triangle"></span><span class="operator-option" ng-click="changeOperator(\'+\', $event)">+</span><span class="operator-option" ng-click="changeOperator(\'-\', $event)">-</span><span class="operator-option" ng-click="changeOperator(\'*\', $event)">*</span><span class="operator-option" ng-click="changeOperator(\'/\', $event)">/</span><span class="operator-option" ng-click="changeOperator(\'AND\', $event)">AND</span><span class="operator-option" ng-click="changeOperator(\'OR\', $event)">OR</span><span class="operator-option add-bracket" ng-click="addBrackets($event)" ng-hide="query.bracketIds.indexOf('+e+') > -1">(brackets)</span><span class="operator-option remove-bracket" ng-show="query.bracketIds.indexOf('+e+') > -1" ng-click="removeBrackets($event)"><strike>(brackets)</strike></span></div></div></div>',r.operandSelection='<div class="operand-selection popover-parent" data-opererand-id="'+e+'"><span class="query-builder-btn query-builder-btn-dropdown query-text" ng-click="togglePopover($event)"><span ng-if="query.operands['+e+"].colName || query.operands["+e+'].custom">{{query.operands['+e+'].colName+" "+query.operands['+e+'].operation+" "+query.operands['+e+'].value+""+query.operands['+e+'].custom}}</span><span ng-hide="query.operands['+e+"].colName || query.operands["+e+'].custom">Enter Query</span></span><div class="operand-popover query-popover"><div class="operand-popover-content"><span class="triangle"></span><div class="popover-header"><div class="heading"><span>Query Type</span></div><div class="query-types"><div class="query-type"><input type="radio" name="query-type-'+e+'" id="query-type-'+e+'-basic" value="basic" ng-model="query.operands['+e+'].type" ng-change="changeQueryType('+e+",'basic' )\"/><label for=\"query-type-"+e+'-basic">Basic</label></div><div class="query-type"><input type="radio" name="query-type-'+e+'" id="query-type-'+e+'-custom" value="custom" ng-model="query.operands['+e+'].type" ng-change="changeQueryType('+e+",'custom' )\"/><label for=\"query-type-"+e+'-custom">Custom</label></div></div></div><div class="popover-body"><div ng-show="query.operands['+e+'].type==\'basic\'"><div class="col-name-wrapper"><label>Select Column</label><select ng-model="query.operands['+e+'].colName" ng-options="col for col in columns"></select></div><div class="operation-wrapper"><label>Select Operation</label><select ng-model="query.operands['+e+'].operation" ng-options="opreration for opreration in operations"></select></div><div class="value-wrapper"><label>Value</label><input type="text" ng-model="query.operands['+e+'].value" /></div></div><div ng-show="query.operands['+e+"].type=='custom'\"><textarea ng-model=\"query.operands["+e+'].custom" plaveholder="Enter custom sub query"></textarea></div><div class="done-btn-wrapper"><button class="query-builder-btn small no-margins" ng-click="togglePopover($event)">Done</button></div></div></div></div></div>',r},a=function(a,n,t,o,s){var p=0,c=n.split(/((?:\(|\)|[A-Z]+|\d+))/g),i=0;expressionArray=c.filter(function(e){return""!=e});for(var l=0;l<expressionArray.length;l++){var d=expressionArray[l],u=r(l);if("("==d){var v=o[p],y='<span class="bracket opening-bracket" data-bracket-id="'+v+'">(</span>';a.find(".query-builder-wrapper").append(y),p+=1}else if(")"==d){var v=o[p],b='<span class="bracket closing-bracket" data-bracket-id="'+v+'">)</span>';a.find(".query-builder-wrapper").append(b),p+=1}else if("AND"==d||"OR"==d){var u=r(parseInt(i));a.find(".query-builder-wrapper").append(e(u.operator)(s))}else if(!isNaN(d)){var u=r(parseInt(d));a.find(".query-builder-wrapper").append(e(u.operandSelection)(s)),i=parseInt(i),i+=1}}};return{get:r,build:a}}])}(angular);