!function(e){var r=e.module("ngQueryBuilder",[]);r.directive("queryBuilder",function(r,a){return{restrict:"EA",scope:{data:"=",columns:"=",operations:"="},link:function(n,o,t){var s=n.data,p=a.get,c={type:"custom",colName:"",operation:"",value:"",custom:""},i={type:"basic",colName:"",operation:"",value:"",custom:""};n.query=s;var l=s.expression?s.expression.match(/[^A-Za-z()]/g):0;n.currIndex=s.expression?l[l.length-1]:0,s.expression=s.expression?s.expression:null,s.operands=s.operands||[e.copy(i)],s.bracketIds=s.bracketIds||[],n.togglePopover=function(r){var a=e.element(r.target).closest(".popover-parent").hasClass("active");e.element(".popover-parent").removeClass("active"),a||e.element(r.target).closest(".popover-parent").addClass("active")},n.newEntry=function(a){n.currIndex+=1,currIndex=n.currIndex,n.query.operands.push(e.copy(i));var t=p(currIndex);o.find(".query-builder-wrapper").append(r(t.operator)(n)),o.find(".query-builder-wrapper").append(r(t.operandSelection)(n)),n.query.expression=u(),console.log(n.query)},n.changeQueryType=function(r,a){"basic"==a?n.query.operands[r]=e.copy(i):n.query.operands[r]=e.copy(c)},n.changeOperator=function(r,a){var o=e.element(a.target).closest(".operator-wrapper");o.find(".operator").text(r),o.removeClass("active"),n.query.expression=u()},n.addBrackets=function(r){var a=e.element(r.target).closest(".operator-wrapper"),o=a.attr("data-operator-id"),t=a.next(),s=a.prev(),p='<span class="bracket opening-bracket" data-bracket-id="'+o+'">(</span>',c='<span class="bracket closing-bracket" data-bracket-id="'+o+'">)</span>';if(console.log("next",t,"prev",s),t.hasClass("bracket opening-bracket"))for(t=t.next(),openingBracketsCount=1;t.length>0;){if(t.hasClass("bracket opening-bracket"))openingBracketsCount+=1;else if(t.hasClass("bracket closing-bracket")&&(openingBracketsCount-=1,0==openingBracketsCount)){e.element(t).after(c);break}t=t.next()}else t.after(c);if(s.hasClass("bracket closing-bracket"))for(s=s.prev(),closingBracketsCount=1;s.length>0;){if(s.hasClass("bracket closing-bracket"))closingBracketsCount+=1;else if(s.hasClass("bracket opening-bracket")&&(closingBracketsCount-=1,0==closingBracketsCount)){e.element(s).before(p);break}s=s.prev()}else s.before(p);a.removeClass("active"),d(),n.query.expression=u()},n.removeBrackets=function(r){var a=e.element(r.target).closest(".operator-wrapper"),o=a.attr("data-operator-id"),t=a.closest(".query-builder-wrapper");t.find('.bracket[data-bracket-id="'+o+'"]').remove(),a.removeClass("active"),d(),n.query.expression=u()};var d=function(){for(var r=o.find(".query-builder-wrapper").find(".bracket"),a=[],t=0;t<r.length;t++)bracketId=e.element(r[t]).attr("data-bracket-id"),a.push(parseInt(bracketId));n.query.bracketIds=a,console.log(n.query.bracketIds)},u=function(){for(var r=[],a=e.element(".query-builder-wrapper").children(),n=0;n<a.length;n++){var o=e.element(a[n]),t=o.text();o.hasClass("bracket")?r.push(t):o.hasClass("operator-wrapper")?(t=o.find(".operator").text(),r.push(t)):(t=o.attr("data-opererand-id"),r.push(t))}return r.join("")},v=function(e,a){var t=0,s=e.split(/((?:\(|\)|[A-Z]+|\d+))/g),c=0;_.remove(s,function(e){return""==e});for(var i=0;i<s.length;i++){var l=s[i],d=p(i);if("("==l){var u=n.query.bracketIds[t],v='<span class="bracket opening-bracket" data-bracket-id="'+u+'">(</span>';o.find(".query-builder-wrapper").append(v),t+=1}else if(")"==l){var u=n.query.bracketIds[t],y='<span class="bracket closing-bracket" data-bracket-id="'+u+'">)</span>';o.find(".query-builder-wrapper").append(y),t+=1}else if("AND"==l||"OR"==l){var d=p(parseInt(c));o.find(".query-builder-wrapper").append(r(d.operator)(n))}else if(!isNaN(l)){var d=p(parseInt(l));o.find(".query-builder-wrapper").append(r(d.operandSelection)(n)),c+=1}}};o.append('<div class="query-builder-wrapper"></div>'),o.append('<div class="add-more-wrapper"></div>'),o.find(".add-more-wrapper").append(r(p(0).addMoreBtn)(n)),n.query.expression?v(n.query.expression,n.query.operands):o.find(".query-builder-wrapper").append(r(p(0).operandSelection)(n)),console.log(n.query.bracketIds),e.element(".query-builder-wrapper").on("click",".popover-parent",function(e){e.stopPropagation()}),e.element("body").on("click",function(){e.element(".query-builder-wrapper .popover-parent").removeClass("active")})}}}),r.factory("templates",function(e){return{get:function(e){var r={};return r.addMoreBtn='<span class="new-entry-btn" ng-click="newEntry($event)" data-curr-index="{{currIndex}}"><i class="material-icons">add_circle</i></span>',r.operator='<div class="operator-wrapper popover-parent" data-operator-id="'+e+'"><span class="operator query-builder-label neutral" ng-click="togglePopover($event)">AND</span><div class="operator-popover query-popover"><div class="popover-body"><span class="triangle"></span><span class="operator-option" ng-click="changeOperator(\'+\', $event)">+</span><span class="operator-option" ng-click="changeOperator(\'-\', $event)">-</span><span class="operator-option" ng-click="changeOperator(\'*\', $event)">*</span><span class="operator-option" ng-click="changeOperator(\'/\', $event)">/</span><span class="operator-option" ng-click="changeOperator(\'AND\', $event)">AND</span><span class="operator-option" ng-click="changeOperator(\'OR\', $event)">OR</span><span class="operator-option add-bracket" ng-click="addBrackets($event)" ng-hide="query.bracketIds.indexOf('+e+') > -1">(brackets)</span><span class="operator-option remove-bracket" ng-show="query.bracketIds.indexOf('+e+') > -1" ng-click="removeBrackets($event)"><strike>(brackets)</strike></span></div></div></div>',r.operandSelection='<div class="operand-selection popover-parent" data-opererand-id="'+e+'"><span class="query-builder-btn query-builder-btn-dropdown query-text" ng-click="togglePopover($event)"><span ng-if="query.operands['+e+"].colName || query.operands["+e+'].custom">{{query.operands['+e+'].colName+" "+query.operands['+e+'].operation+" "+query.operands['+e+'].value+""+query.operands['+e+'].custom}}</span><span ng-hide="query.operands['+e+"].colName || query.operands["+e+'].custom">Make Selection</span></span><div class="operand-popover query-popover"><div class="operand-popover-content"><span class="triangle"></span><div class="popover-header"><div class="heading"><span>Query Type</span></div><div class="query-types"><div class="query-type"><input type="radio" name="query-type-'+e+'" id="query-type-'+e+'-basic" value="basic" ng-model="query.operands['+e+'].type" ng-change="changeQueryType('+e+",'basic' )\"/><label for=\"query-type-"+e+'-basic">Basic</label></div><div class="query-type"><input type="radio" name="query-type-'+e+'" id="query-type-'+e+'-custom" value="custom" ng-model="query.operands['+e+'].type" ng-change="changeQueryType('+e+",'custom' )\"/><label for=\"query-type-"+e+'-custom">Custom</label></div></div></div><div class="popover-body"><div ng-show="query.operands['+e+'].type==\'basic\'"><div class="col-name-wrapper"><label>Select Column</label><select ng-model="query.operands['+e+'].colName" ng-options="col for col in columns"></select></div><div class="operation-wrapper"><label>Select Operation</label><select ng-model="query.operands['+e+'].operation" ng-options="opreration for opreration in operations"></select></div><div class="value-wrapper"><label>Value</label><input type="text" ng-model="query.operands['+e+'].value" /></div></div><div ng-show="query.operands['+e+"].type=='custom'\"><textarea ng-model=\"query.operands["+e+'].custom" plaveholder="Enter custom sub query"></textarea></div><div class="done-btn-wrapper"><button class="query-builder-btn small no-margins" ng-click="togglePopover($event)">Done</button></div></div></div></div></div>',r}}})}(angular);