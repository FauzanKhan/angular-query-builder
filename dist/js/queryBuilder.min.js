!function(e){var r=e.module("ngQueryBuilder",[]);r.directive("queryBuilder",function(r){return{restrict:"EA",scope:{data:"=",columns:"=",operations:"="},link:function(a,n,o){var t=a.data,s={type:"custom",colName:"",operation:"",value:"",custom:""},p={type:"basic",colName:"",operation:"",value:"",custom:""};a.query=t;var c=t.expression?t.expression.match(/[^A-Za-z()]/g):0;a.currIndex=t.expression?c[c.length-1]:0,t.expression=t.expression?t.expression:null,t.operands=t.operands||[e.copy(p)],t.bracketIds=t.bracketIds||[],a.togglePopover=function(r){e.element(r.target).closest(".popover-parent").toggleClass("active")},a.newEntry=function(o){a.currIndex+=1,currIndex=a.currIndex,a.query.operands.push(e.copy(p));var t=d(currIndex);n.find(".query-builder-wrapper").append(r(t.operator)(a)),n.find(".query-builder-wrapper").append(r(t.operandSelection)(a)),a.query.expression=l(),console.log(a.query)},a.changeQueryType=function(r,n){"basic"==n?a.query.operands[r]=e.copy(p):a.query.operands[r]=e.copy(s)},a.changeOperator=function(r,n){var o=e.element(n.target).closest(".operator-wrapper");o.find(".operator").text(r),o.removeClass("active"),a.query.expression=l()},a.addBrackets=function(r){var n=e.element(r.target).closest(".operator-wrapper"),o=n.attr("data-operator-id"),t=n.next(),s=n.prev(),p='<span class="bracket opening-bracket" data-bracket-id="'+o+'">(</span>',c='<span class="bracket closing-bracket" data-bracket-id="'+o+'">)</span>';if(console.log("next",t,"prev",s),t.hasClass("bracket opening-bracket"))for(t=t.next(),openingBracketsCount=1;t.length>0;){if(t.hasClass("bracket opening-bracket"))openingBracketsCount+=1;else if(t.hasClass("bracket closing-bracket")&&(openingBracketsCount-=1,0==openingBracketsCount)){e.element(t).after(c);break}t=t.next()}else t.after(c);if(s.hasClass("bracket closing-bracket"))for(s=s.prev(),closingBracketsCount=1;s.length>0;){if(s.hasClass("bracket closing-bracket"))closingBracketsCount+=1;else if(s.hasClass("bracket opening-bracket")&&(closingBracketsCount-=1,0==closingBracketsCount)){e.element(s).before(p);break}s=s.prev()}else s.before(p);n.removeClass("active"),i(),a.query.expression=l()},a.removeBrackets=function(r){var n=e.element(r.target).closest(".operator-wrapper"),o=n.attr("data-operator-id"),t=n.closest(".query-builder-wrapper");t.find('.bracket[data-bracket-id="'+o+'"]').remove(),n.removeClass("active"),i(),a.query.expression=l()};var i=function(){for(var r=n.find(".query-builder-wrapper").find(".bracket"),o=[],t=0;t<r.length;t++)bracketId=e.element(r[t]).attr("data-bracket-id"),o.push(parseInt(bracketId));a.query.bracketIds=o,console.log(a.query.bracketIds)},l=function(){for(var r=[],a=e.element(".query-builder-wrapper").children(),n=0;n<a.length;n++){var o=e.element(a[n]),t=o.text();o.hasClass("bracket")?r.push(t):o.hasClass("operator-wrapper")?(t=o.find(".operator").text(),r.push(t)):(t=o.attr("data-opererand-id"),r.push(t))}return r.join("")},d=function(e){var r={};return r.addMoreBtn='<span class="new-entry-btn" ng-click="newEntry($event)" data-curr-index="{{currIndex}}"><i class="material-icons">add_circle</i></span>',r.operator='<div class="operator-wrapper popover-parent" data-operator-id="'+e+'"><span class="operator query-builder-label neutral" ng-click="togglePopover($event)">AND</span><div class="operator-popover query-popover"><span class="operator-option" ng-click="changeOperator(\'AND\', $event)">AND</span><span class="operator-option" ng-click="changeOperator(\'OR\', $event)">OR</span><span class="operator-option add-bracket" ng-click="addBrackets($event)" ng-hide="query.bracketIds.indexOf('+e+') > -1">(A+B)</span><span class="operator-option remove-bracket" ng-show="query.bracketIds.indexOf('+e+') > -1" ng-click="removeBrackets($event)"><strike>(A+B)</strike></span>',r.operandSelection='<div class="operand-selection popover-parent" data-opererand-id="'+e+'"><span class="query-builder-btn default query-builder-btn-dropdown" ng-click="togglePopover($event)"><span ng-if="query.operands['+e+"].colName || query.operands["+e+'].custom">{{query.operands['+e+'].colName+" "+query.operands['+e+'].operation+" "+query.operands['+e+'].value+""+query.operands['+e+'].custom}}</span><span ng-hide="query.operands['+e+"].colName || query.operands["+e+'].custom">Make Selection</span></span><div class="operand-popover query-popover"><div class="operand-popover-content"><span class="triangle"></span><div class="popover-header"><div class="heading"><span>Query Type</span></div><div class="query-types"><div class="query-type"><input type="radio" name="query-type-'+e+'" id="query-type-'+e+'-basic" value="basic" ng-model="query.operands['+e+'].type" ng-change="changeQueryType('+e+",'basic' )\"/><label for=\"query-type-"+e+'-basic">Basic</label></div><div class="query-type"><input type="radio" name="query-type-'+e+'" id="query-type-'+e+'-custom" value="custom" ng-model="query.operands['+e+'].type" ng-change="changeQueryType('+e+",'custom' )\"/><label for=\"query-type-"+e+'-custom">Custom</label></div></div></div><div class="popover-body"><div ng-show="query.operands['+e+'].type==\'basic\'"><div class="col-name-wrapper"><label>Select Column</label><select ng-model="query.operands['+e+'].colName" ng-options="col for col in columns"></select></div><div class="operation-wrapper"><label>Select Operation</label><select ng-model="query.operands['+e+'].operation" ng-options="opreration for opreration in operations"></select></div><div class="value-wrapper"><label>Value</label><input type="text" ng-model="query.operands['+e+'].value" /></div></div><div ng-show="query.operands['+e+"].type=='custom'\"><textarea ng-model=\"query.operands["+e+'].custom" plaveholder="Enter custom sub query"></textarea></div><div class="done-btn-wrapper"><query-builder-btn class="query-builder-btn small default no-margins" ng-click="togglePopover($event)">Done</query-builder-btn></div></div></div></div></div>',r},u=function(e,o){var t=0,s=e.split(/((?:\(|\)|[A-Z]+|\d+))/g),p=0;_.remove(s,function(e){return""==e});for(var c=0;c<s.length;c++){var i=s[c],l=d(c);if("("==i){var u=a.query.bracketIds[t],v='<span class="bracket opening-bracket" data-bracket-id="'+u+'">(</span>';n.find(".query-builder-wrapper").append(v),t+=1}else if(")"==i){var u=a.query.bracketIds[t],y='<span class="bracket closing-bracket" data-bracket-id="'+u+'">)</span>';n.find(".query-builder-wrapper").append(y),t+=1}else if("AND"==i||"OR"==i){var l=d(parseInt(p));n.find(".query-builder-wrapper").append(r(l.operator)(a))}else if(!isNaN(i)){var l=d(parseInt(i));n.find(".query-builder-wrapper").append(r(l.operandSelection)(a)),p+=1}}};n.append('<div class="query-builder-wrapper"></div>'),n.append('<div class="add-more-wrapper"></div>'),n.find(".add-more-wrapper").append(r(d(0).addMoreBtn)(a)),a.query.expression?u(a.query.expression,a.query.operands):n.find(".query-builder-wrapper").append(r(d(0).operandSelection)(a)),console.log(a.query.bracketIds),e.element(".query-builder-wrapper").on("click",".popover-parent",function(e){e.stopPropagation()}),e.element("body").on("click",function(){e.element(".query-builder-wrapper .popover-parent").removeClass("active")})}}})}(angular);